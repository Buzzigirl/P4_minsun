<!DOCTYPE html>
<html lang="ko">
<head>
    {% include '_head_styles.html' %}
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat_ui.css') }}">

    <script>
        window.AVATAR_URL = "{{ AVATAR_URL }}";
        window.PLACEHOLDER_AVATAR_URL = "{{ url_for('static', filename='images/peer_placeholder.webp') }}";
        window.USER_ID = "{{ session['user']['student_id'] }}"; 
    </script>
</head>
<body>
    <div class="main-wrapper">
        
        <div class="center-panel">
            <div class="chat-header">
                AI 동료 학습자 - {{ user_name }}님
                <div id="timer" class="timer">남은 시간: 30:00</div>
            </div>
            <div class="chat-box" id="chat-box">
                {% for message in chat_history %}
                    {% if message.role == 'user' %}
                        <div class="message-row user-message-row">
                            <div class="message-content">{{ message.content | replace('\n', '<br>') | safe }}</div>
                        </div>
                    {% elif message.role == 'assistant' %}
                        <div class="message-row ai-message-row">
                            <img src="{{ AVATAR_URL }}" alt="AI 아바타" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/peer_placeholder.webp') }}'">
                            <div class="message-content">{{ message.content | replace('\n', '<br>') | safe }}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="input-form">
                <input type="text" id="user-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode === 13) sendMessage()">
                <button onclick="sendMessage()" title="메시지 전송">
                    <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="right-panel">
            <h2>결과물 제출</h2>
            <p>아래의 버튼을 클릭하여 최종 결과물 제출 및 학습을 종료해 주시기 바랍니다.</p>
            
            <a href="{{ url_for('static', filename='files/final_form.pptx') }}" download>
                <button class="download-button" type="button" style="width: 100%; padding: 10px; margin-bottom: 15px; background-color: #3b5998; color: white; border: none; border-radius: 8px; font-size: 1em; cursor: pointer;">
                    제출물 1: 교육활동 계획서(양식) 다운로드 (ppt)
                </button>
            </a>
            
            <a href="{{ url_for('submit_and_download_log') }}" download>
                <button type="button" style="width: 100%; padding: 10px; margin-bottom: 25px; background-color: #6c757d; color: white; border: none; border-radius: 8px; font-size: 1em; cursor: pointer;">
                    제출물 2: 대화로그 파일 다운로드 (txt)
                </button>
            </a>
            
            <button id="submit-and-end-button" onclick="checkTimeAndShowPopup()">
                결과물 제출 및 학습 종료하기
            </button>
            
            <p style="margin-top: 30px; font-size: 0.9em; color: #e74c3c;">
                주의: 결과물 제출 및 학습 종료하기 버튼 클릭 시 연구 참여가 종료됩니다.
            </p>

            <a href="https://docs.google.com/forms/d/e/1FAIpQLSejTDmVCKloMc2R6w_Q2G-wst8aiJ4JKcyRHurAgiv_R_RVdg/viewform" target="_blank" style="text-decoration: none;">
                <button type="button" style="width: 100%; padding: 10px; margin-top: 10px; background-color: #BCB5E8; color: #3b5998; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; font-weight: bold;">
                    사후 설문조사 참여하기
                </button>
            </a>
        </div>
    </div>

    <div id="end-session-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div id="modal-buttons" class="modal-buttons">
                </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/chat_logic.js') }}"></script>
</body>
</html>