<!DOCTYPE html>
<html lang="ko">
<head>
    {% include '_head_styles.html' %}
</head>
<body>
    <div class="main-wrapper">
                <div class="left-panel">
            <h2>학습 목표 및 배경</h2>
            <h3>1. 현재 상황</h3>
            <p>{{ situation | safe }}</p>
            
            <h3>2. 교내 규칙</h3>
            <p>{{ rules | safe }}</p>

            <h3>3. 해결 과제</h3>
            <p>{{ task | safe }}</p>
        </div>
        
                <div class="center-panel">
            <div class="chat-header">
                AI 동료 학습자 - {{ user_name }}님
            </div>
            <div class="chat-box" id="chat-box">
                                {% for message in chat_history %}
                    {% if message.role == 'user' %}
                        <div class="message-row user-message-row">
                            <div class="message-content">{{ message.content | replace('\n', '<br>') | safe }}</div>
                        </div>
                    {% elif message.role == 'assistant' %}
                        <div class="message-row ai-message-row">
                                                        <img src="{{ AVATAR_URL }}" alt="AI 아바타" class="avatar" onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/peer_placeholder.webp') }}'">
                            <div class="message-content">{{ message.content | replace('\n', '<br>') | safe }}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="input-form">
                <input type="text" id="user-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode === 13) sendMessage()">
                <button onclick="sendMessage()" title="메시지 전송">
                                        <svg class="send-icon" viewBox="0 0 24 24">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        {% include '_submission_panel.html' %}
    </div>

    <script>
        // Flask에서 전달받은 AVATAR_URL 변수를 JavaScript 변수로 저장
        const AVATAR_URL = "{{ AVATAR_URL }}";
        // 🚩 이미지 경로 수정: JavaScript의 대체 이미지 경로
        const PLACEHOLDER_AVATAR_URL = "{{ url_for('static', filename='images/peer_placeholder.webp') }}";
        
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');

        function getAvatarPath() {
            // 이제 AVATAR_URL 변수를 직접 사용합니다.
            return AVATAR_URL;
        }

        function appendMessage(speaker, message) {
            const row = document.createElement('div');
            row.classList.add('message-row', speaker === 'AI' ? 'ai-message-row' : 'user-message-row');

            if (speaker === 'AI') {
                const avatar = document.createElement('img');
                // 수정: AVATAR_URL JavaScript 변수 사용
                avatar.src = AVATAR_URL; 
                avatar.alt = "AI 아바타";
                avatar.classList.add('avatar');
                // 🚩 이미지 경로 수정: appendMessage 함수 내의 대체 이미지 경로
                avatar.onerror = function() { this.onerror=null; this.src=PLACEHOLDER_AVATAR_URL; };
                row.appendChild(avatar);
            }

            const content = document.createElement('div');
            content.classList.add('message-content');
            content.innerHTML = message.replace(/\n/g, '<br>'); 
            row.appendChild(content);

            chatBox.appendChild(row);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showLoading() {
            const loadingRow = document.createElement('div');
            loadingRow.id = 'loading-row';
            loadingRow.classList.add('message-row', 'ai-message-row');

            const avatar = document.createElement('img');
            // 수정: AVATAR_URL JavaScript 변수 사용
            avatar.src = AVATAR_URL; 
            avatar.alt = "AI 아바타";
            avatar.classList.add('avatar');
            // 🚩 이미지 경로 수정: showLoading 함수 내의 대체 이미지 경로
            avatar.onerror = function() { this.onerror=null; this.src=PLACEHOLDER_AVATAR_URL; };
            loadingRow.appendChild(avatar);
            
            const content = document.createElement('div');
            content.classList.add('message-content');
            content.innerHTML = 'AI가 생각 중입니다... <span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>';
            loadingRow.appendChild(content);

            chatBox.appendChild(loadingRow);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            userInput.disabled = true;
        }

        function hideLoading() {
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) {
                loadingRow.remove();
            }
            userInput.disabled = false;
            userInput.focus(); 
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            appendMessage('User', message);
            userInput.value = '';

            showLoading();
            
            fetch('/get_response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => {
                hideLoading();
                if (!response.ok) {
                    return response.json().then(data => { 
                        // API 오류가 콘솔에 찍히도록 logError 대신 직접 console.error 사용
                        console.error('API Error:', data.error || 'Unknown error during API call.');
                        throw new Error(data.error || 'AI 응답을 가져오는 데 실패했습니다.'); 
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    // 서버에서 발생한 오류 (API 통신 오류 등)
                    appendMessage('System', `오류: ${data.error}`);
                } else {
                    // 정상적인 AI 응답
                    appendMessage('AI', data.response);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Fetch error:', error);
                appendMessage('System', `통신 오류: ${error.message}`);
            });
        }

        window.onload = function() {
            chatBox.scrollTop = chatBox.scrollHeight;
            userInput.focus();
        };
    </script>
</body>
</html>